<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>跨平台套利计算器</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
            padding: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 16px;
            font-size: 24px;
            color: #00d9ff;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            backdrop-filter: blur(10px);
        }

        .card h2 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #00d9ff;
        }

        .input-group {
            margin-bottom: 12px;
        }

        .input-group label {
            display: block;
            margin-bottom: 4px;
            color: #aaa;
            font-size: 12px;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
            color: #fff;
            font-size: 14px;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #00d9ff;
        }

        .input-group select option {
            background: #1a1a2e;
            color: #fff;
        }

        .position-row {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
        }

        .position-header {
            display: grid;
            grid-template-columns: 1.5fr 0.8fr 50px 36px;
            gap: 8px;
            align-items: end;
        }

        .position-header .input-group {
            margin-bottom: 0;
        }

        .orders-section {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .order-row {
            display: grid;
            grid-template-columns: 1fr 1fr 30px;
            gap: 8px;
            align-items: end;
            margin-bottom: 6px;
        }

        .order-row .input-group {
            margin-bottom: 0;
        }

        .btn-remove-order {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
            border: none;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            font-size: 12px;
        }

        .btn-remove-order:hover {
            background: rgba(255, 82, 82, 0.4);
        }

        .btn-remove-order:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .btn-add-order {
            background: rgba(0, 217, 255, 0.2);
            color: #00d9ff;
            border: 1px dashed rgba(0, 217, 255, 0.5);
            border-radius: 4px;
            padding: 6px 12px;
            cursor: pointer;
            font-size: 11px;
            width: 100%;
            margin-top: 6px;
        }

        .btn-add-order:hover {
            background: rgba(0, 217, 255, 0.3);
        }

        .position-summary {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            padding: 6px 8px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
            font-size: 12px;
        }

        .position-summary .avg-price {
            color: #00d9ff;
        }

        .position-summary .total-shares {
            color: #aaa;
        }

        .fee-info {
            font-size: 11px;
            color: #ffc107;
            margin-top: 6px;
            padding: 6px 8px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
        }

        .position-type {
            padding: 8px;
            border-radius: 6px;
            font-weight: bold;
            text-align: center;
            font-size: 12px;
        }

        .position-yes {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .position-no {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-add {
            background: #00d9ff;
            color: #1a1a2e;
            width: 100%;
            margin-top: 8px;
        }

        .btn-add:hover {
            background: #00b8d9;
        }

        .btn-remove {
            background: rgba(255, 82, 82, 0.3);
            color: #ff5252;
            padding: 8px 10px;
            font-size: 14px;
        }

        .btn-remove:hover {
            background: rgba(255, 82, 82, 0.5);
        }

        .btn-remove:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .result-card {
            background: rgba(0, 217, 255, 0.1);
            border: 1px solid rgba(0, 217, 255, 0.3);
        }

        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-label {
            color: #aaa;
            font-size: 13px;
        }

        .result-value {
            font-weight: bold;
            font-size: 15px;
        }

        .profit-positive { color: #00c853; }
        .profit-negative { color: #ff5252; }
        .profit-neutral { color: #ffd600; }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 16px;
            font-weight: bold;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .status-arbitrage {
            background: rgba(0, 200, 83, 0.2);
            color: #00c853;
        }

        .status-no-arbitrage {
            background: rgba(255, 82, 82, 0.2);
            color: #ff5252;
        }

        .status-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
        }

        .breakdown {
            margin-top: 12px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 6px;
        }

        .breakdown h3 {
            font-size: 12px;
            color: #aaa;
            margin-bottom: 8px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 12px;
        }

        .scenario-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .scenario-box {
            padding: 8px;
            border-radius: 6px;
            text-align: center;
            font-size: 12px;
        }

        .scenario-box.yes-wins {
            background: rgba(0, 200, 83, 0.1);
            border: 1px solid rgba(0, 200, 83, 0.3);
        }

        .scenario-box.no-wins {
            background: rgba(255, 82, 82, 0.1);
            border: 1px solid rgba(255, 82, 82, 0.3);
        }

        .scenario-box .label {
            color: #aaa;
            margin-bottom: 4px;
        }

        .scenario-box .value {
            font-weight: bold;
            font-size: 14px;
        }

        .warning-text {
            color: #ffc107;
            font-size: 12px;
            margin-bottom: 8px;
            padding: 8px;
            background: rgba(255, 193, 7, 0.1);
            border-radius: 4px;
        }

        @media (max-width: 900px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 600px) {
            .position-header {
                grid-template-columns: 1fr 1fr;
            }
            .position-header .input-group:first-child {
                grid-column: span 2;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>跨平台套利计算器</h1>

        <div class="main-layout">
            <div class="card">
                <h2>平台持仓</h2>
                <div id="positions"></div>
                <button class="btn btn-add" onclick="addPosition()">+ 添加平台</button>
            </div>

            <div class="card result-card" id="resultCard">
                <div id="statusBadge" class="status-badge">等待输入...</div>
                <h2>计算结果</h2>
                <div id="results"></div>
                <div class="breakdown" id="breakdown"></div>
            </div>
        </div>
    </div>

    <script>
        const FEE_K = 0.08;
        const MIN_FEE = 0.5;

        const PLATFORMS = [
            { value: 'polymarket', label: 'Polymarket', hasFee: false },
            { value: 'opinion', label: 'Opinion', hasFee: true },
            { value: 'kalshi', label: 'Kalshi', hasFee: false },
            { value: 'predictit', label: 'PredictIt', hasFee: false },
            { value: 'other', label: '其他', hasFee: false }
        ];

        let positions = [
            {
                platform: 'polymarket',
                type: 'YES',
                orders: [{ price: '', quantity: '' }]
            },
            {
                platform: 'opinion',
                type: 'NO',
                orders: [{ price: '', quantity: '' }]
            }
        ];

        function getPlatformInfo(platformValue) {
            return PLATFORMS.find(p => p.value === platformValue) || PLATFORMS[0];
        }

        function calculatePositionStats(position) {
            const orders = position.orders;
            if (orders.length === 0) return { avgPrice: 0, totalShares: 0, totalCost: 0 };

            let totalValue = 0;
            let totalShares = 0;

            orders.forEach(order => {
                totalValue += order.price * order.quantity;
                totalShares += order.quantity;
            });

            const avgPrice = totalShares > 0 ? totalValue / totalShares : 0;
            const totalCost = (avgPrice / 100) * totalShares;

            return { avgPrice, totalShares, totalCost };
        }

        function calculateOpinionFee(avgPrice, totalShares) {
            const p = avgPrice / 100;  // 价格转为小数 (52¢ -> 0.52)
            const effectiveFeeRate = FEE_K * p * (1 - p);
            const notional = p * totalShares;  // 名义价值 = 价格 * 数量
            const calculatedFee = notional * effectiveFeeRate;
            const actualFee = Math.max(calculatedFee, MIN_FEE);
            return {
                feeRate: effectiveFeeRate,
                calculatedFee: calculatedFee,
                actualFee: actualFee,
                isMinFee: calculatedFee < MIN_FEE
            };
        }

        function renderPositions() {
            const container = document.getElementById('positions');

            container.innerHTML = positions.map((pos, posIndex) => {
                const platformInfo = getPlatformInfo(pos.platform);
                const stats = calculatePositionStats(pos);
                const feeInfo = platformInfo.hasFee && stats.totalShares > 0
                    ? calculateOpinionFee(stats.avgPrice, stats.totalShares)
                    : null;

                return `
                <div class="position-row">
                    <div class="position-header">
                        <div class="input-group">
                            <label>平台</label>
                            <select onchange="updatePosition(${posIndex}, 'platform', this.value)">
                                ${PLATFORMS.map(p => `
                                    <option value="${p.value}" ${pos.platform === p.value ? 'selected' : ''}>
                                        ${p.label}${p.hasFee ? ' *' : ''}
                                    </option>
                                `).join('')}
                            </select>
                        </div>
                        <div class="input-group">
                            <label>类型</label>
                            <select onchange="updatePosition(${posIndex}, 'type', this.value)">
                                <option value="YES" ${pos.type === 'YES' ? 'selected' : ''}>YES</option>
                                <option value="NO" ${pos.type === 'NO' ? 'selected' : ''}>NO</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>&nbsp;</label>
                            <div class="position-type ${pos.type === 'YES' ? 'position-yes' : 'position-no'}">
                                ${pos.type}
                            </div>
                        </div>
                        <div class="input-group">
                            <label>&nbsp;</label>
                            <button class="btn btn-remove" onclick="removePosition(${posIndex})"
                                    ${positions.length <= 2 ? 'disabled' : ''}>X</button>
                        </div>
                    </div>

                    <div class="orders-section">
                        ${pos.orders.map((order, orderIndex) => `
                            <div class="order-row">
                                <div class="input-group">
                                    <label>价格 (¢)</label>
                                    <input type="number" value="${order.price}" min="0" max="100" step="any"
                                           oninput="updateOrder(${posIndex}, ${orderIndex}, 'price', parseFloat(this.value) || 0)">
                                </div>
                                <div class="input-group">
                                    <label>数量</label>
                                    <input type="number" value="${order.quantity}" min="0" step="any"
                                           oninput="updateOrder(${posIndex}, ${orderIndex}, 'quantity', parseFloat(this.value) || 0)">
                                </div>
                                <button class="btn-remove-order" onclick="removeOrder(${posIndex}, ${orderIndex})"
                                        ${pos.orders.length <= 1 ? 'disabled' : ''}>×</button>
                            </div>
                        `).join('')}
                        <button class="btn-add-order" onclick="addOrder(${posIndex})">+ 添加挂单</button>
                    </div>

                    <div class="position-summary">
                        <span class="avg-price">均价: ${stats.avgPrice.toFixed(2)}¢</span>
                        <span class="total-shares">数量: ${stats.totalShares}</span>
                    </div>

                    ${platformInfo.hasFee && feeInfo ? `
                    <div class="fee-info">
                        <span>手续费: $${feeInfo.actualFee.toFixed(2)} ${feeInfo.isMinFee ? '(最低$0.5)' : ''}</span>
                        <span>费率: ${(feeInfo.feeRate * 100).toFixed(3)}%</span>
                    </div>
                    ` : ''}
                </div>
            `}).join('');

            calculate();
        }

        function addPosition() {
            positions.push({
                platform: 'polymarket',
                type: 'YES',
                orders: [{ price: '', quantity: '' }]
            });
            renderPositions();
        }

        function removePosition(index) {
            if (positions.length > 2) {
                positions.splice(index, 1);
                renderPositions();
            }
        }

        function updatePosition(index, field, value) {
            positions[index][field] = value;
            renderPositions();
        }

        function addOrder(posIndex) {
            positions[posIndex].orders.push({ price: '', quantity: '' });
            renderPositions();
        }

        function removeOrder(posIndex, orderIndex) {
            if (positions[posIndex].orders.length > 1) {
                positions[posIndex].orders.splice(orderIndex, 1);
                renderPositions();
            }
        }

        function updateOrder(posIndex, orderIndex, field, value) {
            positions[posIndex].orders[orderIndex][field] = value;
            // 只更新计算，不重新渲染（保持焦点）
            updatePositionSummary(posIndex);
            calculate();
        }

        function updatePositionSummary(posIndex) {
            const pos = positions[posIndex];
            const platformInfo = getPlatformInfo(pos.platform);
            const stats = calculatePositionStats(pos);

            const positionRows = document.querySelectorAll('.position-row');
            if (positionRows[posIndex]) {
                const summaryEl = positionRows[posIndex].querySelector('.position-summary');
                if (summaryEl) {
                    summaryEl.innerHTML = `
                        <span class="avg-price">均价: ${stats.avgPrice.toFixed(2)}¢</span>
                        <span class="total-shares">数量: ${stats.totalShares}</span>
                    `;
                }

                if (platformInfo.hasFee && stats.totalShares > 0) {
                    const feeInfo = calculateOpinionFee(stats.avgPrice, stats.totalShares);
                    const feeEl = positionRows[posIndex].querySelector('.fee-info');
                    if (feeEl) {
                        feeEl.innerHTML = `
                            <span>手续费: $${feeInfo.actualFee.toFixed(2)} ${feeInfo.isMinFee ? '(最低$0.5)' : ''}</span>
                            <span>费率: ${(feeInfo.feeRate * 100).toFixed(3)}%</span>
                        `;
                    }
                }
            }
        }

        function calculate() {
            const statusBadge = document.getElementById('statusBadge');
            const resultsDiv = document.getElementById('results');
            const breakdownDiv = document.getElementById('breakdown');

            // 计算每个平台的统计数据
            const positionStats = positions.map(pos => {
                const platformInfo = getPlatformInfo(pos.platform);
                const stats = calculatePositionStats(pos);
                let fee = 0;

                if (platformInfo.hasFee && stats.totalShares > 0) {
                    const feeInfo = calculateOpinionFee(stats.avgPrice, stats.totalShares);
                    fee = feeInfo.actualFee;
                }

                return {
                    ...pos,
                    platformInfo,
                    ...stats,
                    fee
                };
            });

            // 检查所有平台的 shares 是否相同
            const shareCounts = positionStats.map(p => p.totalShares);
            const uniqueShares = [...new Set(shareCounts.filter(s => s > 0))];
            const sharesMatch = uniqueShares.length <= 1;
            const shares = uniqueShares[0] || 0;

            if (shares <= 0) {
                statusBadge.className = 'status-badge';
                statusBadge.textContent = '等待输入...';
                resultsDiv.innerHTML = '';
                breakdownDiv.innerHTML = '';
                return;
            }

            // 计算总成本
            let totalCost = 0;
            let totalFees = 0;
            let yesCount = 0;
            let noCount = 0;

            positionStats.forEach(pos => {
                totalCost += pos.totalCost + pos.fee;
                totalFees += pos.fee;
                if (pos.type === 'YES') yesCount++;
                else noCount++;
            });

            const hasYes = yesCount > 0;
            const hasNo = noCount > 0;

            const payoutIfYes = yesCount * shares;
            const profitIfYes = payoutIfYes - totalCost;

            const payoutIfNo = noCount * shares;
            const profitIfNo = payoutIfNo - totalCost;

            const guaranteedProfit = Math.min(profitIfYes, profitIfNo);
            const hasArbitrage = hasYes && hasNo && guaranteedProfit > 0 && sharesMatch;

            if (!sharesMatch) {
                statusBadge.className = 'status-badge status-warning';
                statusBadge.textContent = '各平台数量不一致';
            } else if (hasArbitrage) {
                statusBadge.className = 'status-badge status-arbitrage';
                statusBadge.textContent = '存在套利机会!';
            } else if (hasYes && hasNo) {
                statusBadge.className = 'status-badge status-no-arbitrage';
                statusBadge.textContent = '无套利机会';
            } else {
                statusBadge.className = 'status-badge status-no-arbitrage';
                statusBadge.textContent = '需要同时持有 YES 和 NO';
            }

            const profitClass = guaranteedProfit > 0 ? 'profit-positive' :
                               (guaranteedProfit < 0 ? 'profit-negative' : 'profit-neutral');

            let warningHtml = '';
            if (!sharesMatch) {
                warningHtml = `<div class="warning-text">各平台 shares 数量不一致: ${shareCounts.join(', ')}</div>`;
            }

            resultsDiv.innerHTML = `
                ${warningHtml}
                <div class="scenario-row">
                    <div class="scenario-box yes-wins">
                        <div class="label">YES 赢</div>
                        <div class="value ${profitIfYes >= 0 ? 'profit-positive' : 'profit-negative'}">
                            ${profitIfYes >= 0 ? '+' : ''}$${profitIfYes.toFixed(2)}
                        </div>
                    </div>
                    <div class="scenario-box no-wins">
                        <div class="label">NO 赢</div>
                        <div class="value ${profitIfNo >= 0 ? 'profit-positive' : 'profit-negative'}">
                            ${profitIfNo >= 0 ? '+' : ''}$${profitIfNo.toFixed(2)}
                        </div>
                    </div>
                </div>
                <div class="result-item">
                    <span class="result-label">总投入成本</span>
                    <span class="result-value">$${totalCost.toFixed(2)}</span>
                </div>
                ${totalFees > 0 ? `
                <div class="result-item">
                    <span class="result-label">其中手续费</span>
                    <span class="result-value" style="color: #ffc107;">$${totalFees.toFixed(2)}</span>
                </div>
                ` : ''}
                <div class="result-item">
                    <span class="result-label">保证利润</span>
                    <span class="result-value ${profitClass}">
                        ${guaranteedProfit >= 0 ? '+' : ''}$${guaranteedProfit.toFixed(2)}
                    </span>
                </div>
                <div class="result-item">
                    <span class="result-label">收益率</span>
                    <span class="result-value ${profitClass}">
                        ${totalCost > 0 ? ((guaranteedProfit / totalCost) * 100).toFixed(2) : 0}%
                    </span>
                </div>
            `;

            let breakdownHtml = '<h3>持仓明细</h3>';
            positionStats.forEach(pos => {
                let feeStr = pos.fee > 0 ? ` +$${pos.fee.toFixed(2)}` : '';
                let totalPosCost = pos.totalCost + pos.fee;

                breakdownHtml += `
                    <div class="breakdown-item">
                        <span>${pos.platformInfo.label} ${pos.type}</span>
                        <span>${pos.avgPrice.toFixed(2)}¢ × ${pos.totalShares} = $${totalPosCost.toFixed(2)}</span>
                    </div>
                `;
            });

            breakdownDiv.innerHTML = breakdownHtml;
        }

        renderPositions();
    </script>
</body>
</html>
